<!DOCTYPE html>
<html>
  <head>
    <title>Issue Tracker - Project Page</title>
    <meta
      name="description"
      content="An example of the Free Code Camp Issue Tracker Project"
    />
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- FAVICONS -->
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="/public/favicons/apple-touch-icon.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="/public/favicons/favicon-32x32.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="/public/favicons/favicon-16x16.png"
    />
    <link rel="manifest" href="/public/site.webmanifest" />

    <!-- STYLES -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-0evHe/X+R7YkIZDRvuzKMRqM+OrBnVFBL6DOitfPri4tjfHxaWutUpFmBp4vmVor"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://use.fontawesome.com/releases/v5.15.4/css/all.css"
      integrity="sha384-DyZ88mC6Up2uqS4h/KRgHuoeGwBcD4Ng9SiP4dIRy0EXTlnuz47vAwmeGwVChigm"
      crossorigin="anonymous"
    />
    <link
      href="https://fonts.googleapis.com/css?family=Roboto"
      rel="stylesheet"
      type="text/css"
    />
    <link rel="stylesheet" href="/public/style.css" />
  </head>

  <body>
    <!-- NAVBAR -->
    <nav class="navbar navbar-expand-lg navbar-dark">
      <div class="container-fluid">
        <a class="navbar-brand" href=".">Issue Tracker</a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNavDropdown"
          aria-controls="navbarNavDropdown"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNavDropdown">
          <ul class="navbar-nav">
            <li class="nav-item">
              <a
                class="nav-link active"
                href="https://plcoster.github.io/homepage/"
              >
                Home
              </a>
            </li>
            <li class="nav-item dropdown">
              <a
                class="nav-link dropdown-toggle"
                href="#"
                id="navbarDropdownMenuLink"
                role="button"
                data-bs-toggle="dropdown"
                aria-expanded="false"
              >
                FreeCodeCamp QA Projects
              </a>
              <ul
                class="dropdown-menu"
                aria-labelledby="navbarDropdownMenuLink"
              >
                <li>
                  <a
                    class="dropdown-item"
                    href="https://fcc-qa-project1.plcoster.repl.co"
                  >
                    Metric - Imperial Converter
                  </a>
                </li>
                <li>
                  <a
                    class="dropdown-item"
                    href="https://fcc-qa-project2.plcoster.repl.co"
                  >
                    Issue Tracker
                  </a>
                </li>
                <li>
                  <a
                    class="dropdown-item"
                    href="https://fcc-qa-project3.plcoster.repl.co"
                  >
                    Personal Library
                  </a>
                </li>
                <li>
                  <a
                    class="dropdown-item"
                    href="https://fcc-qa-project4.plcoster.repl.co"
                  >
                    Sudoku Solver
                  </a>
                </li>
                <li>
                  <a
                    class="dropdown-item"
                    href="https://fcc-qa-project5.plcoster.repl.co"
                  >
                    American British Translator
                  </a>
                </li>
              </ul>
            </li>
            <li class="nav-item">
              <a
                class="nav-link"
                href="https://plcoster.github.io/homepage/projects.html"
              >
                All Projects
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="https://github.com/PLCoster">
                <i class="fab fa-github"></i> Github
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="https://linkedin.com/in/plcoster">
                <i class="fab fa-linkedin"></i>
                LinkedIn
              </a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="container">
      <main>
        <h1>
          <img
            class="logo"
            src="/public/logo.png"
            alt="White icon of a bug on a square green background"
          />Issue Page for: <code><span class="projectTitle"></span></code>
        </h1>

        <hr />
        <section class="d-flex justify-content-center">
          <form id="newIssue" method="post" action="/api/">
            <h3>Create an Issue:</h3>
            <p>
              <code>POST /api/issues/<span class="projectTitle"></span></code>
            </p>
            <input
              type="text"
              name="issue_title"
              placeholder="*Title"
              required
            />
            <textarea
              type="text"
              name="issue_text"
              placeholder="*Text"
              required
            ></textarea>
            <input
              type="text"
              name="created_by"
              placeholder="*Created by"
              required=""
            />
            <input
              type="text"
              name="assigned_to"
              placeholder="(opt)Assigned to"
            />
            <input
              type="text"
              name="status_text"
              placeholder="(opt)Status text"
            />
            <button type="submit" class="btn btn-sm btn-success">
              Submit Issue
            </button>
          </form>
        </section>
        <hr />
        <section>
          <h3>
            All Issues for <code><span class="projectTitle"></span></code>:
          </h3>
          <!-- ISSUES DISPLAY -->
          <div
            id="issueDisplay"
            class="d-flex flex-column align-items-center"
          ></div>
        </section>

        <hr />
      </main>

      <footer>
        <p>
          A project set by
          <a href="https://www.freecodecamp.org/">freeCodeCamp</a>
        </p>
      </footer>
    </div>

    <!-- Your web-app is https, so your scripts need to be too -->
    <!-- Bootstrap Script -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-pprn3073KE6tl6bjs2QrFaJGz5/SUsLqktiwsUTF55Jfv3qYSDhgCecCxMW52nD2"
      crossorigin="anonymous"
    ></script>

    <!-- jquery -->
    <script
      src="https://code.jquery.com/jquery-2.2.1.min.js"
      integrity="sha256-gvQgAFzTH6trSrAWoH1iPo9Xc96QxSZ3feW6kem+O00="
      crossorigin="anonymous"
    ></script>
    <script>
      $(function () {
        let currentProject = window.location.pathname.replace(/\//g, '');
        let url = '/api/issues/' + currentProject;
        $('.projectTitle').text(currentProject);
        $.ajax({
          type: 'GET',
          url: url,
          success: function (data) {
            let issues = [];
            data.forEach(function (ele) {
              console.log(ele);
              let openstatus;
              ele.open ? (openstatus = 'open') : (openstatus = 'closed');
              let single = [
                `<div class="issue ${openstatus}">`,
                `<div class="d-flex justify-content-between">
                  <p class="id">
                    id: ${ele._id}
                  </p>
                  <p class="status">
                    ${openstatus}
                  </p>
                </div>`,
                `<h3 class="issue-title">${ele.issue_title}</h3>`,
                '<hr>',
                `<p><strong>Issue Details:</strong></p>`,
                '<p>' + ele.issue_text + '</p>',
                `<p><strong>Issue Status:</strong></p>`,
                '<p>' + ele.status_text + '</p>',
                `<div class="d-flex">
                  <p class="id"><b>Created by: </b>${ele.created_by}</p>
                  <p class="id"><b>Assigned to: </b>${ele.assigned_to}</p>
                 </div>`,
                `<div class="d-flex justify-content-between flex-wrap">
                  <p class="id"><b>Created on: </b>${ele.created_on}</p>
                  <p class="id"><b>Last updated: </b>${ele.updated_on}</p>
                 </div>`,
                `<div class="d-flex justify-content-between">
                    ${
                      ele.open
                        ? `<button href="#" class="closeIssue btn btn-sm btn-warning" id="${ele._id}">Close Issue</button>`
                        : ''
                    }
                    <button href="#" class="deleteIssue btn btn-sm btn-danger" id="${
                      ele._id
                    }">Delete Issue</button>
                  </div>`,
                '</div>',
              ];
              issues.push(single.join(''));
            });
            $('#issueDisplay').html(issues.join(''));
          },
        });

        // Custom Submit form for Creating a new Issue
        $('#newIssue').submit(function (e) {
          e.preventDefault();
          $(this).attr('action', '/api/issues/' + currentProject);
          $.ajax({
            type: 'POST',
            url: url,
            data: $(this).serialize(),
            success: function (data) {
              window.location.reload(true);
            },
          });
        });

        // Clicking close issue button closes the desired issue
        $('#issueDisplay').on('click', '.closeIssue', function (e) {
          const _id = $(this).attr('id');
          let url = '/api/issues/' + currentProject;
          $.ajax({
            type: 'PUT',
            url: url,
            data: { _id, open: false },
            success: function (data) {
              alert(`Issue ${_id} has been closed!`);
              window.location.reload(true);
            },
          });
          e.preventDefault();
        });

        // Clicking delete issue button deletes the given issue
        $('#issueDisplay').on('click', '.deleteIssue', function (e) {
          const _id = $(this).attr('id');
          let url = '/api/issues/' + currentProject;
          $.ajax({
            type: 'DELETE',
            url: url,
            data: { _id },
            success: function (data) {
              alert(`Issue ${_id} has been deleted!`);
              window.location.reload(true);
            },
          });
          e.preventDefault();
        });
      });
    </script>
  </body>
</html>
